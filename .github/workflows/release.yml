name: Release

on:
  push:
    tags:
      - 'release/*'

permissions:
  contents: write  

jobs:

  build:

    runs-on: ubuntu-latest

    steps:
    - name: Check out repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Set build variables (from tag)
      id: buildvars
      shell: bash
      run: |
        GIT_TAG="${GITHUB_REF_NAME}"
        GIT_VER="${GIT_TAG#release/}"
        if [[ $GIT_VER =~ ^[0-9]+\.[0-9]+\.[0-9]+-[A-Za-z0-9]+$ ]]; then
          GH_TYPE='Release Candidate'
        else
          GH_TYPE='Release'
        fi
        echo "GIT_VER=$GIT_VER" >> $GITHUB_ENV
        echo "GIT_TAG=$GIT_TAG" >> $GITHUB_ENV
        echo "GH_TYPE=$GH_TYPE" >> $GITHUB_ENV

    - name: Make release package
      run: zip -q -r -9 "inav-dashboard-ethos-${{ env.GIT_VER }}.zip" scripts

    - name: Create Release
      run: |
        python .github/scripts/extract-release-notes.py "${{ env.GIT_VER }}" Releases.md > Notes.md
        gh release create ${{ env.GIT_TAG }} --notes-file Notes.md --title "Inav Dashboard for Ethos - ${{ env.GH_TYPE }} ${{ env.GIT_VER }}" *.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}